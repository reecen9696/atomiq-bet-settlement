# Atomik Wallet Devnet E2E Handoff (2026-01-17)

This document is a reboot-safe snapshot of where we are, what we’re trying to accomplish, and what changed across UI/backend/processor to enable a real devnet end-to-end flow.

## Goal (What we’re trying to do)

Run a full devnet E2E flow using the `vault` Anchor program:

1. Initialize Casino + Vault PDAs on devnet
2. Deposit SOL into the user vault
3. Approve an allowance (nonce-based, deterministic)
4. Place bets from the Test UI (no on-chain signature per bet)
5. Backend queues bets → Processor batches → Processor submits Solana transactions
6. On-chain spend is executed via `spend_from_allowance` and payouts happen for winners

Success means:

- New bets created from the UI are processed (confirmed tx signature), not stuck.
- Failures are visible (preflight logs surfaced) and after too many retries bets move to a terminal state.

## Critical IDs / Networks

- Network: Solana devnet
- Vault program id (devnet): `HTg6Cs11FNiRXjQ2wFiQodKrVuTQdEJYk8j4RtfX56rP`

### PDAs / Seeds

- Casino PDA seed: `[b"casino"]`
- Vault authority PDA seed: `[b"vault-authority", casino]`
- User vault PDA seed: `[b"vault", casino, user]`

### Allowance v2 (nonce-based)

We moved away from timestamp-based allowance PDAs due to seed mismatch/flakiness.

- Nonce registry PDA seed: `[b"allowance-nonce", user, casino]`
- Allowance PDA seed (v2): `[b"allowance", user, casino, nonce_le_bytes]`
- `approve_allowance_v2` requires `nonce == nonce_registry.next_nonce` and then increments `next_nonce`.

### Processor keypair

- Processor service keypair is configured at `services/processor/.env` → `PROCESSOR_KEYPAIR=/Users/reece/code/projects/atomik-wallet/test-keypair.json`
- Pubkey for that keypair (expected): `61jttWnSoqvb1N6YDxTX6PUpfb7BsPoVJw2DwxWZB4rL`

Important: on-chain `casino.processor` must equal this pubkey or spends/payouts will fail with `UnauthorizedProcessor`.

## Services / How to run

From repo root:

- Start services: `./start-services.sh`
  - Backend: http://localhost:3001
  - Processor metrics: http://localhost:9091/metrics
- Stop services: `./stop-services.sh`
- Tail logs: `./view-logs.sh` or `tail -f logs/backend.log logs/processor.log`

### Test UI

- Config: `test-ui/.env.local`
  - `VITE_SOLANA_RPC_URL=...`
  - `VITE_SOLANA_NETWORK=devnet`
  - `VITE_VAULT_PROGRAM_ID=HTg6Cs11FNiRXjQ2wFiQodKrVuTQdEJYk8j4RtfX56rP`

## What was changed (high level)

### 1) Processor batch sizing + per-tx limits

Problem: we hit processor errors like “Batch too large: 12 bets (max 5)” and then Solana tx-size limits.

Solution:

- Processor now:
  - claims up to a configurable batch size
  - splits into chunks of `max_bets_per_tx` per Solana transaction

Key env vars (processor):

- `PROCESSOR_BATCH_SIZE`
- `PROCESSOR_MAX_BETS_PER_TX`

Key files:

- `services/processor/src/config.rs`
- `services/processor/src/worker_pool.rs`
- `services/processor/src/solana_tx.rs`

### 2) Backend retry backoff + stop after N failures

Problem: failed bets were retried indefinitely; we needed backoff + a terminal state.

Solution:

- Backend tracks `retry_count` and schedules retries using exponential backoff.
- After `BET_MAX_RETRIES`, bet becomes terminal (`failed_manual_review`) and stops retrying.

Key env vars (backend):

- `BET_MAX_RETRIES`
- `BET_RETRY_BACKOFF_BASE_MS`
- `BET_RETRY_BACKOFF_MAX_MS`

Key file:

- `services/backend/src/repository/bet_repository.rs`

### 3) Carry `allowance_pda` and `vault_address` end-to-end

Root cause of on-chain failures:

- Bets created earlier lacked correct vault/allowance addresses (often `TEMP_VAULT_ADDRESS`).
- Processor would derive/guess the wrong allowance PDA, leading to:
  - `Preflight simulation failed: InstructionError(0, Custom(3012))`
  - Anchor: `AccountNotInitialized` for account `allowance`

Fix:

- UI includes `vault_address` and `allowance_pda` in CreateBet requests.
- Backend persists these fields.
- Processor uses `bet.allowance_pda` when present.

Key files:

- `test-ui/src/components/BettingInterface.tsx`
- `test-ui/src/components/VaultManager.tsx` (saves last allowance PDA in localStorage)
- `test-ui/src/types/index.ts`
- `services/backend/src/domain.rs`
- `services/backend/src/handlers/bets.rs`
- `services/backend/src/repository/bet_repository.rs`
- `services/processor/src/domain.rs`

### 4) Processor allowance PDA fallback (nonce registry)

To avoid relying on the UI always passing `allowance_pda`, processor gained a safe fallback:

- If bet’s `allowance_pda` is missing or not initialized, processor reads `AllowanceNonceRegistry` on-chain,
  derives `nonce = next_nonce - 1`, derives the allowance PDA, and verifies the allowance account exists.
- Legacy timestamp-based fallback was removed (it produces wrong PDAs under the nonce model).

Key file:

- `services/processor/src/solana_tx.rs`

## Current blocker (as of 2026-01-17)

RPC/DNS connectivity:

- `curl` and `solana` CLI calls to devnet and mainnet fail with hostname resolution timeouts.
- This is not an Alchemy-key issue or devnet-only issue; it’s general DNS/network failure.

Until DNS/network is fixed, we can’t:

- fetch casino/vault/allowance accounts
- approve allowance v2
- process bets on-chain

## After reboot: exact “resume work” checklist

### A) Fix networking first

1. Confirm internet works in a browser.
2. If on VPN/proxy, toggle it off/on.
3. Set DNS servers (macOS): add `1.1.1.1` and `8.8.8.8`.
4. Flush DNS:
   - `sudo dscacheutil -flushcache; sudo killall -HUP mDNSResponder`
5. Verify hostname resolution:
   - `curl -I -m 10 https://api.mainnet-beta.solana.com`
   - `curl -sS -m 10 -H 'Content-Type: application/json' --data '{"jsonrpc":"2.0","id":1,"method":"getHealth"}' https://api.devnet.solana.com`

### B) Verify Solana CLI works with devnet

- `solana config set --url https://solana-devnet.g.alchemy.com/v2/bsLgryJK7I4nDQ4YDvr5l`
- `solana block-height`

### C) Verify casino exists and processor is authorized

1. Compute the casino PDA (seed `[b"casino"]`) for the NEW program. This PDA is:
   - `FhTXCNZFUZwKzhYBdWsCbmQ6Uv3WLmn9fsst9wHtwZks`
   - (OLD program had: `Hk51nMxSqn2fqAqQtvuLn2KxzT79fS5n5ksAJ86TJpCj`)
2. Fetch the account:
   - `solana account FhTXCNZFUZwKzhYBdWsCbmQ6Uv3WLmn9fsst9wHtwZks --output json > /tmp/casino.json`
3. Decode `casino.processor` and ensure it equals processor pubkey `61jtt...`.
   - If not equal, expected next failure is `UnauthorizedProcessor`.

### D) Approve allowance v2 and place a fresh bet

1. Start services:
   - `./start-services.sh`
2. In the Test UI:
   - Initialize PDAs if needed
   - Deposit SOL
   - Approve Allowance (v2 / nonce)
3. Place a new bet (don’t reuse old Redis bets created before address plumbing).

### E) Optional cleanup of stale pending bets

If old bets keep reappearing:

- `redis-cli del bets:pending:queue bets:processing:queue bets:pending`

## Debugging notes / known pitfalls

- Node REPL: typing `node` opens interactive mode. Exit with `.exit` or Ctrl+D.
- Public devnet RPC (`api.devnet.solana.com`) often rate-limits (429). Prefer Alchemy once DNS works.
- If you see `AccountNotInitialized` for `allowance`, it usually means:
  - allowance wasn’t approved via v2 (nonce registry not created), or
  - bet didn’t carry `allowance_pda` and nonce-registry lookup failed, or
  - you’re looking at an old bet created before the UI started sending the correct fields.

## Summary

- Nonce-based deterministic allowances are implemented.
- UI → backend → processor now carries `allowance_pda` and `vault_address`.
- Processor batching is chunked per-tx and backend retries have backoff + terminal failure.
- The immediate next step is restoring DNS/network so Solana RPC works again; then validate casino authorization and run a fresh approve+bet end-to-end.
